#!/bin/bash

root=`git rev-parse --show-toplevel || PWD`
server_name=$(basename "$root")
socket_file=$(kak -l | grep $server_name)

if [[ $socket_file == "" ]]; then
    # Create new kakoune daemon for current dir
    nohup kak -d -s $server_name > /dev/null 3>&2 &
    sleep 0.1
fi

# and run kakoune (with any arguments passed to the script)
if [[ $# -eq 0 ]]; then
    files=$(fd -tf . $root | sk -m)
else
    files=$@
fi
kak -c $server_name $files
